<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Collection de montres</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg-main: #e8dfd1;        /* beige soutenu */
      --card-bg: #f6f1e7;        /* cr√®me contrast√© */
      --accent: #6b6153;         /* brun-gris fonc√© (style Birthday) */
      --accent-soft: #d1c5b7;    /* beige brun clair */
      --accent-soft-2: #c7baaa;  /* beige gris√© */
      --text-main: #2c2a27;      /* gris-brun presque noir */
      --text-muted: #6a645c;     /* gris-brun doux */
      --danger: #944444;         /* rouge plus lisible */
      --border-soft: #b7aa99;    /* brun clair contrast√© */
      --row-even: #f2ebe0;       /* z√©brage clair */
      --row-odd: #e0d5c6;        /* z√©brage fonc√© */
      --row-hover: #d6cabb;      /* survol plus visible */
      --input-bg: #fdfbf8;       /* cr√®me lisible */
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-main);
      color: var(--text-main);
    }

    h1, h2, h3 {
      margin: 0;
      font-weight: 600;
      color: #2f2b27;
    }

    a { color: var(--accent); text-decoration: none; }

    .app {
      max-width: 1200px;
      margin: 20px auto 24px;
      padding: 0 16px;
    }

    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 16px;
    }

    .app-title {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .app-title small {
      color: var(--text-muted);
      font-size: 13px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(145, 129, 104, 0.16);
      color: #4a4339;
      font-size: 12px;
      gap: 6px;
      border: 1px solid rgba(170, 154, 130, 0.5);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 380px) minmax(0, 1fr);
      gap: 16px;
      align-items: flex-start;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 14px 14px 12px;
      box-shadow:
        0 6px 14px rgba(0, 0, 0, 0.06),
        0 0 0 1px rgba(189, 173, 149, 0.6);
      border: 1px solid rgba(198, 183, 160, 0.9);
    }

    .card-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }

    .card-header small {
      color: var(--text-muted);
      font-size: 12px;
    }

    .card-section-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    /* Formulaire */
    form {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .field-group {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    @media (max-width: 600px) {
      .field-group {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
    }

    .field label {
      color: var(--text-muted);
    }

    .field small {
      color: var(--text-muted);
      font-size: 11px;
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    select,
    textarea {
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      padding: 6px 8px;
      font-size: 13px;
      outline: none;
      background: var(--input-bg);
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
      width: 100%;
      color: var(--text-main);
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(117, 107, 94, 0.45);
      background: #fffaf1;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    .checkbox-inline {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .checkbox-inline input {
      width: auto;
    }

    .actions-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
    }

    .actions-row small {
      color: var(--text-muted);
      font-size: 11px;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
      transition: background 0.15s ease, box-shadow 0.15s ease, transform 0.05s ease;
    }

    button:active {
      transform: translateY(1px);
    }

    .btn-primary {
      background: var(--accent);
      color: #fffdf8;
      box-shadow: 0 4px 10px rgba(74, 64, 52, 0.35);
    }

    .btn-primary:hover {
      background: #595043;
    }

    .btn-secondary {
      background: var(--accent-soft);
      color: var(--text-main);
      box-shadow: 0 2px 5px rgba(130, 120, 105, 0.22);
    }

    .btn-secondary:hover {
      background: var(--accent-soft-2);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-muted);
      padding-inline: 6px;
      box-shadow: none;
    }

    .btn-ghost:hover {
      background: rgba(203, 187, 161, 0.35);
    }

    .btn-danger {
      background: rgba(148, 68, 68, 0.1);
      color: var(--danger);
      box-shadow: none;
    }

    .btn-danger:hover {
      background: rgba(148, 68, 68, 0.2);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(216, 197, 165, 0.8);
      color: #41372b;
      border: 1px solid rgba(183, 165, 136, 0.9);
    }

    .pill span {
      font-weight: 600;
    }

    .summary-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
    }

    .summary-item {
      background: var(--accent-soft-2);
      color: var(--text-main);
      border-radius: 999px;
      padding: 3px 9px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid rgba(206, 190, 160, 0.9);
    }

    .summary-item strong {
      font-weight: 600;
    }

    .summary-item.positive strong {
      color: #22693b;
    }

    .summary-item.negative strong {
      color: #8b2a2a;
    }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 6px 0 8px;
      align-items: center;
      font-size: 12px;
      color: var(--text-muted);
    }

    .filter-row select {
      max-width: 180px;
    }

    .backup-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      font-size: 12px;
      margin-bottom: 8px;
      padding: 6px 8px;
      border-radius: 8px;
      background: #efe4d0;
      border: 1px solid #d2c1a7;
    }

    .backup-bar span {
      color: var(--text-muted);
    }

    .backup-bar input[type="file"] {
      display: none;
    }

    .counter-dot {
  min-width: 22px;
  height: 22px;
  padding: 0 6px;
  border-radius: 999px;

  background: #ffffff;       /* fond blanc */
  color: #000000;            /* chiffres noirs */
  border: 2px solid #000000; /* contour noir */

  display: inline-flex;
  align-items: center;
  justify-content: center;

  font-size: 13px;
  font-weight: 700;
  line-height: 1;
}

    /* Tableau */
    .table-container {
      margin-top: 6px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: #f0e4d3;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
    }

    table {
      width: 100%;
      min-width: 1100px;
      border-collapse: collapse;
      font-size: 12px;
    }

    thead {
      background: #e0d4bf;
    }

    th, td {
      padding: 6px 7px;
      text-align: left;
      vertical-align: middle;
    }

    th {
      font-weight: 600;
      color: #3d352a;
      border-bottom: 1px solid rgba(141, 124, 99, 0.9);
      position: relative;
      user-select: none;
      white-space: nowrap;
    }

    th.sortable {
      cursor: pointer;
    }

    th.sortable::after {
      content: "‚áÖ";
      font-size: 10px;
      opacity: 0.4;
      margin-left: 4px;
    }

    th.sortable[data-sort-dir="asc"]::after {
      content: "‚Üë";
      opacity: 0.9;
    }

    th.sortable[data-sort-dir="desc"]::after {
      content: "‚Üì";
      opacity: 0.9;
    }

    tbody tr:nth-child(odd) {
      background: var(--row-odd);
    }

    tbody tr:nth-child(even) {
      background: var(--row-even);
    }

    tbody tr:hover {
      background: var(--row-hover);
    }

    td {
      border-bottom: 1px solid rgba(180, 164, 140, 0.55);
    }

    td.actions {
      white-space: nowrap;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(210, 190, 160, 0.7);
      color: #3e3528;
      border: 1px solid rgba(190, 170, 140, 0.9);
    }

    .chip-type-montre {
      background: #d9c9ac;
      color: #3b3123;
      border-color: #c2ae8c;
    }

    .chip-type-poche {
      background: #bcdcff;        /* bleu pastel clair */
      color: #1f3a5a;             /* texte bleu fonc√© */
      border: 1px solid #7aa7d9;  /* contour bleu */
    }

    .chip-type-horloge {
      background: #b8e6b0;        /* vert pastel */
      color: #2f4a2a;             /* texte vert fonc√© */
      border: 1px solid #7fbf72;  /* contour vert */
    }

    .chip-type-officier {
      background: #ffe28a;         /* jaune pastel */
      color: #5a4a12;              /* texte brun fonc√© lisible */
      border: 1px solid #d1b25a;   /* contour jaune fonc√© */
    }

    .chip-type-autre {
      background: rgba(255, 182, 193, 0.85); /* rose clair */
      color: #4a2c34; /* texte prune fonc√© lisible */
      border: 1px solid rgba(190, 120, 140, 0.9);
    }

    .muted {
      color: var(--text-muted);
    }

    /* Colonne Notes √©largie */
    td.notes-col, th.notes-col {
      min-width: 260px;
      white-space: normal;
    }

    .no-data {
      padding: 12px;
      text-align: center;
      font-size: 13px;
      color: var(--text-muted);
      background: #f4ead7;
    }

    footer {
      margin-top: 10px;
      text-align: right;
      font-size: 11px;
      color: var(--text-muted);
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div class="app-title">
        <h1>Collection de montres</h1>
        <small>Montres, montres de poche, horloges et pendules de voyage.</small>
      </div>
      <div class="badge">
        Nombre
        <span class="counter-dot" id="totalCountDot">0</span>
      </div>
    </header>

    <div class="layout">
      <!-- Colonne formulaire -->
      <section class="card" id="formCard">
        <div class="card-header">
          <div>
            <h2 id="formTitle">Ajouter une pi√®ce</h2>
            <small id="formSubtitle">Renseigne les informations de base et les valeurs.</small>
          </div>
          <button type="button" class="btn-ghost" id="resetFormBtn" title="R√©initialiser le formulaire">
            ‚Ü∫ Formulaire
          </button>
        </div>

        <form id="watchForm">
          <div class="field-group">
            <div class="field">
              <label for="type">Type de pi√®ce *</label>
              <select id="type" required>
                <option value="montre">Montre poignet</option>
                <option value="montre_poche">Montre de poche</option>
                <option value="horloge">Horloge</option>
                <option value="pendule_officier">Pendule voyage</option>
                <option value="autre">Autre</option>
              </select>
            </div>

            <div class="field">
              <label for="brand">Marque</label>
              <input type="text" id="brand" placeholder="Rolex, Omega, Longines..." />
            </div>
          </div>

          <div class="field-group">
            <div class="field">
              <label for="model">Mod√®le / R√©f√©rence</label>
              <input type="text" id="model" placeholder="Submariner, Calatrava..." />
            </div>
            <div class="field">
              <label for="serial">N¬∞ de s√©rie (optionnel)</label>
              <input type="text" id="serial" placeholder="Num√©ro, calibre, etc." />
            </div>
          </div>

          <div class="field-group">
            <div class="field">
              <label for="epochYear">√âpoque (ann√©e de la montre)</label>
              <input type="number" id="epochYear" min="0" max="2100" step="1" placeholder="1750" />
            </div>
            <div class="field">
              <label for="acquisitionYear">Ann√©e d‚Äôacquisition</label>
              <input type="number" id="acquisitionYear" min="0" max="2100" step="1" placeholder="2014" />
            </div>
          </div>

          <div class="field-group">
            <div class="field">
              <label for="acquisitionPlace">Lieu / Provenance</label>
              <input type="text" id="acquisitionPlace" placeholder="March√©, vente, h√©ritage..." />
            </div>
            <div class="field">
              <label for="purchasePrice">Valeur d‚Äôachat</label>
              <input type="number" id="purchasePrice" step="0.01" min="0" placeholder="0.00" />
              <small>Devise : EUR</small>
            </div>
          </div>

          <div class="field-group">
            <div class="field">
              <label for="currentValue">Valeur actuelle</label>
              <input type="number" id="currentValue" step="0.01" min="0" placeholder="0.00" />
              <small>√Ä la date ci-dessous</small>
            </div>
            <div class="field">
              <label for="currentValueDate">Date de valorisation</label>
              <input type="date" id="currentValueDate" />
            </div>
          </div>

          <div class="field">
            <label class="checkbox-inline">
              <input type="checkbox" id="fullSet" />
              Full set (bo√Æte, papiers, accessoires)
            </label>
          </div>

          <div class="field">
            <label for="notes">Notes</label>
            <textarea id="notes" placeholder="√âtat, complications, histoire, commentaires personnels..."></textarea>
          </div>

          <div class="actions-row">
            <button type="submit" class="btn-primary" id="submitBtn">
              üíæ Enregistrer la pi√®ce
            </button>
            <small>Les donn√©es sont aussi gard√©es dans ton navigateur.</small>
          </div>
        </form>
      </section>

      <!-- Colonne tableau -->
      <section class="card">
        <div class="card-header">
          <div>
            <h2>Vue d‚Äôensemble</h2>
            <small>Tableau triable, tons beige et z√©brage.</small>
          </div>
          <div class="pill">
            üìä <span id="totalCountLabel">0</span> pi√®ces
          </div>
        </div>

        <div class="card-section-title">R√©sum√© rapide</div>
        <div class="summary-bar">
          <div class="summary-item">
            Total achat : <strong id="sumPurchase">0.00 ‚Ç¨</strong>
          </div>
          <div class="summary-item">
            Valeur actuelle : <strong id="sumCurrent">0.00 ‚Ç¨</strong>
          </div>
          <div class="summary-item" id="sumDeltaWrapper">
            √âcart : <strong id="sumDelta">0.00 ‚Ç¨</strong>
          </div>
        </div>

        <div class="backup-bar">
          <span>üíæ Sauvegarde manuelle :</span>
          <button type="button" class="btn-secondary" id="exportBackupBtn">Exporter</button>
          <button type="button" class="btn-secondary" id="importBackupBtn">Importer</button>
          <input type="file" id="backupFileInput" accept="application/json" />
        </div>

        <div class="filter-row">
          <span>Filtrer par type :</span>
          <select id="filterType">
            <option value="all">Tous les types</option>
            <option value="montre">Montre poignet</option>
            <option value="montre_poche">Montre de poche</option>
            <option value="horloge">Horloge</option>
            <option value="pendule_officier">Pendule voyage</option>
            <option value="autre">Autre</option>
          </select>
        </div>

        <div class="table-container">
          <table id="watchTable">
            <thead>
              <tr>
                <th class="sortable" data-key="type">Type</th>
                <th class="sortable" data-key="brand">Marque / Mod√®le</th>
                <th class="sortable" data-key="epochYear">√âpoque</th>
                <th class="sortable" data-key="acquisitionYear">Acquisition</th>
                <th class="sortable" data-key="purchasePrice">Achat (‚Ç¨)</th>
                <th class="sortable" data-key="currentValue">Valeur actuelle (‚Ç¨)</th>
                <th class="sortable" data-key="currentValueDate">Date valeur</th>
                <th class="sortable" data-key="fullSet">Full set</th>
                <th class="notes-col">Notes</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="watchTableBody">
            </tbody>
          </table>
          <div class="no-data" id="noDataMsg">
            Aucune pi√®ce pour l‚Äôinstant. Ajoute ta premi√®re montre √† gauche ‚úîÔ∏è
          </div>
        </div>
      </section>
    </div>

    <footer>
      ¬© 2025 ‚Äì Pierre Charlier ‚Äì Collection de montres ‚Ä¢ v1.9
    </footer>
  </div>

  <script>
    const STORAGE_KEY = "watchCollectionV1";

    let collection = [];
    let filteredType = "all";
    let currentSort = { key: null, dir: "asc" };
    let editingId = null;

    function loadFromStorage() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      try {
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) {
          collection = parsed.map((item, index) => {
            const base = typeof item === "object" && item !== null ? item : {};
            let acquisitionYear = base.acquisitionYear;
            if (!acquisitionYear && base.acquisitionDate) {
              const yearFromDate = String(base.acquisitionDate).slice(0, 4);
              if (/^\d{4}$/.test(yearFromDate)) {
                acquisitionYear = yearFromDate;
              }
            }
            return {
              id: base.id || Date.now() + index,
              type: base.type || "autre",
              brand: base.brand || "",
              model: base.model || "",
              serial: base.serial || "",
              epochYear: base.epochYear || "",
              acquisitionYear: acquisitionYear || "",
              acquisitionPlace: base.acquisitionPlace || "",
              purchasePrice:
                base.purchasePrice !== undefined && base.purchasePrice !== null
                  ? Number(base.purchasePrice)
                  : null,
              currentValue:
                base.currentValue !== undefined && base.currentValue !== null
                  ? Number(base.currentValue)
                  : null,
              currentValueDate: base.currentValueDate || "",
              fullSet: !!base.fullSet,
              notes: base.notes || ""
            };
          });
        }
      } catch (e) {
        console.error("Erreur de parsing localStorage", e);
      }
    }

    function saveToStorage() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(collection));
    }

    function formatCurrency(value) {
      if (value === null || value === undefined || value === "" || isNaN(value)) return "-";
      const num = Number(value);
      return num.toLocaleString("fr-FR", {
        style: "currency",
        currency: "EUR",
        maximumFractionDigits: 2
      });
    }

    function formatDate(dateStr) {
      if (!dateStr) return "-";
      const parts = dateStr.split("-");
      if (parts.length !== 3) return dateStr;
      return `${parts[2]} / ${parts[1]} / ${parts[0]}`;
    }

    function typeLabel(type) {
      const t = String(type).toLowerCase();
      switch (t) {
        case "montre": return "Montre";
        case "montre_poche": return "Montre poche";
        case "horloge": return "Horloge";
        case "pendule_officier":
        case "pendule_voyage":
          return "Pendule voyage";
        case "autre": return "Autre";
        default: return type || "-";
      }
    }

    function typeChipClass(type) {
      const t = String(type).toLowerCase();
      if (t === "montre") return "chip chip-type-montre";
      if (t === "montre_poche") return "chip chip-type-poche";
      if (t === "horloge") return "chip chip-type-horloge";
      if (t === "pendule_officier" || t === "pendule_voyage")
        return "chip chip-type-officier";
      if (t === "autre") return "chip chip-type-autre";
      return "chip";
    }

    function renderSummary() {
      const sumPurchase = collection.reduce(
        (acc, item) => acc + (Number(item.purchasePrice) || 0),
        0
      );
      const sumCurrent = collection.reduce(
        (acc, item) => acc + (Number(item.currentValue) || 0),
        0
      );
      const delta = sumCurrent - sumPurchase;

      document.getElementById("sumPurchase").textContent = formatCurrency(sumPurchase);
      document.getElementById("sumCurrent").textContent = formatCurrency(sumCurrent);

      const formattedDelta = formatCurrency(Math.abs(delta));
      document.getElementById("sumDelta").textContent =
        (delta >= 0 ? "+" : "-") + " " + formattedDelta.replace("-", "");

      const wrapper = document.getElementById("sumDeltaWrapper");
      wrapper.classList.remove("positive", "negative");
      if (delta > 0) wrapper.classList.add("positive");
      else if (delta < 0) wrapper.classList.add("negative");

      document.getElementById("totalCountLabel").textContent = collection.length;
      document.getElementById("totalCountDot").textContent = collection.length;
    }

    function getFilteredCollection() {
      if (filteredType === "all") return collection.slice();
      return collection.filter(item => item.type === filteredType);
    }

    function sortCollection(list) {
      if (!currentSort.key) return list;
      const { key, dir } = currentSort;
      const multiplier = dir === "asc" ? 1 : -1;

      return list.sort((a, b) => {
        let av = a[key];
        let bv = b[key];

        if (key === "currentValueDate") {
          if (!av && !bv) return 0;
          if (!av) return -1 * multiplier;
          if (!bv) return 1 * multiplier;
          return (av < bv ? -1 : av > bv ? 1 : 0) * multiplier;
        }

        if (key === "fullSet") {
          const aVal = a.fullSet ? 1 : 0;
          const bVal = b.fullSet ? 1 : 0;
          return (aVal - bVal) * multiplier;
        }

        const aNum = Number(av);
        const bNum = Number(bv);
        const bothNumeric = !isNaN(aNum) && !isNaN(bNum) && av !== "" && bv !== "";
        if (bothNumeric) {
          return (aNum - bNum) * multiplier;
        }

        av = (av || "").toString().toLowerCase();
        bv = (bv || "").toString().toLowerCase();
        if (av < bv) return -1 * multiplier;
        if (av > bv) return 1 * multiplier;
        return 0;
      });
    }

    function clearSortIndicators() {
      const ths = document.querySelectorAll("#watchTable thead th.sortable");
      ths.forEach(th => th.removeAttribute("data-sort-dir"));
    }

    function updateSortIndicator() {
      clearSortIndicators();
      if (!currentSort.key) return;
      const th = document.querySelector(
        `#watchTable thead th.sortable[data-key="${currentSort.key}"]`
      );
      if (th) th.setAttribute("data-sort-dir", currentSort.dir);
    }

    function renderTable() {
      const tbody = document.getElementById("watchTableBody");
      const noDataMsg = document.getElementById("noDataMsg");
      tbody.innerHTML = "";

      const filtered = getFilteredCollection();
      const sorted = sortCollection(filtered);

      noDataMsg.style.display = sorted.length === 0 ? "block" : "none";

      sorted.forEach(item => {
        const tr = document.createElement("tr");

        // Type
        const tdType = document.createElement("td");
        const spanType = document.createElement("span");
        spanType.className = typeChipClass(item.type);
        spanType.textContent = typeLabel(item.type);
        tdType.appendChild(spanType);
        tr.appendChild(tdType);

        // Marque / mod√®le
        const tdBrand = document.createElement("td");
        const line1 = document.createElement("div");
        line1.textContent = [item.brand, item.model].filter(Boolean).join(" ‚Ä¢ ") || "-";
        const line2 = document.createElement("div");
        line2.className = "muted";
        line2.style.fontSize = "11px";
        line2.textContent = item.serial ? `N¬∞ ${item.serial}` : "";
        tdBrand.appendChild(line1);
        if (line2.textContent) tdBrand.appendChild(line2);
        tr.appendChild(tdBrand);

        // √âpoque
        const tdEpoch = document.createElement("td");
        tdEpoch.textContent = item.epochYear || "-";
        tr.appendChild(tdEpoch);

        // Ann√©e acquisition
        const tdAcqYear = document.createElement("td");
        tdAcqYear.textContent = item.acquisitionYear || "-";
        tr.appendChild(tdAcqYear);

        // Prix achat
        const tdPurchase = document.createElement("td");
        tdPurchase.textContent = formatCurrency(item.purchasePrice);
        tr.appendChild(tdPurchase);

        // Valeur actuelle
        const tdCurrent = document.createElement("td");
        tdCurrent.textContent = formatCurrency(item.currentValue);
        tr.appendChild(tdCurrent);

        // Date valeur
        const tdValDate = document.createElement("td");
        tdValDate.textContent = formatDate(item.currentValueDate);
        tr.appendChild(tdValDate);

        // Full set
        const tdFullSet = document.createElement("td");
        tdFullSet.style.textAlign = "center";
        if (item.fullSet) {
          tdFullSet.textContent = "‚úîÔ∏è";
        } else {
          tdFullSet.innerHTML = '<span class="muted">‚Äî</span>';
        }
        tr.appendChild(tdFullSet);

        // Notes
        const tdNotes = document.createElement("td");
        tdNotes.className = "notes-col";
        tdNotes.textContent = item.notes || "";
        tr.appendChild(tdNotes);

        // Actions
        const tdActions = document.createElement("td");
        tdActions.className = "actions";

        const editBtn = document.createElement("button");
        editBtn.type = "button";
        editBtn.className = "btn-secondary";
        editBtn.textContent = "‚úèÔ∏è";
        editBtn.title = "Modifier cette pi√®ce";
        editBtn.addEventListener("click", () => startEdit(item.id));

        const delBtn = document.createElement("button");
        delBtn.type = "button";
        delBtn.className = "btn-danger";
        delBtn.textContent = "üóë";
        delBtn.title = "Supprimer cette pi√®ce";
        delBtn.addEventListener("click", () => deleteItem(item.id));

        tdActions.appendChild(editBtn);
        tdActions.appendChild(delBtn);

        tr.appendChild(tdActions);
        tbody.appendChild(tr);
      });

      renderSummary();
      updateSortIndicator();
    }

    function resetForm() {
      document.getElementById("watchForm").reset();
      document.getElementById("type").value = "montre";
      editingId = null;
      document.getElementById("formTitle").textContent = "Ajouter une pi√®ce";
      document.getElementById("formSubtitle").textContent =
        "Renseigne les informations de base et les valeurs.";
      document.getElementById("submitBtn").textContent = "üíæ Enregistrer la pi√®ce";
    }

    function startEdit(id) {
      const item = collection.find(i => i.id === id);
      if (!item) return;
      editingId = id;

      document.getElementById("formTitle").textContent = "Modifier la pi√®ce";
      document.getElementById("formSubtitle").textContent =
        "Modifie les informations puis enregistre ‚úîÔ∏è";
      document.getElementById("submitBtn").textContent = "‚úîÔ∏è Mettre √† jour la pi√®ce";

      document.getElementById("type").value = item.type || "montre";
      document.getElementById("brand").value = item.brand || "";
      document.getElementById("model").value = item.model || "";
      document.getElementById("serial").value = item.serial || "";
      document.getElementById("epochYear").value = item.epochYear || "";
      document.getElementById("acquisitionYear").value = item.acquisitionYear || "";
      document.getElementById("acquisitionPlace").value = item.acquisitionPlace || "";
      document.getElementById("purchasePrice").value =
        item.purchasePrice !== null && item.purchasePrice !== undefined
          ? item.purchasePrice
          : "";
      document.getElementById("currentValue").value =
        item.currentValue !== null && item.currentValue !== undefined
          ? item.currentValue
          : "";
      document.getElementById("currentValueDate").value = item.currentValueDate || "";
      document.getElementById("fullSet").checked = !!item.fullSet;
      document.getElementById("notes").value = item.notes || "";

      document.getElementById("formCard").scrollIntoView({
        behavior: "smooth",
        block: "start"
      });
    }

    function deleteItem(id) {
      const item = collection.find(i => i.id === id);
      const label = item
        ? `${typeLabel(item.type)} ${item.brand || ""} ${item.model || ""}`.trim()
        : "cette pi√®ce";
      if (!confirm(`Supprimer ${label} ?`)) return;
      collection = collection.filter(i => i.id !== id);
      saveToStorage();
      renderTable();
      if (editingId === id) resetForm();
    }

    function handleFormSubmit(event) {
      event.preventDefault();
      const type = document.getElementById("type").value;
      const brand = document.getElementById("brand").value.trim();
      const model = document.getElementById("model").value.trim();
      const serial = document.getElementById("serial").value.trim();
      const epochYearRaw = document.getElementById("epochYear").value;
      const acquisitionYearRaw = document.getElementById("acquisitionYear").value;
      const acquisitionPlace = document.getElementById("acquisitionPlace").value.trim();
      const purchasePriceRaw = document.getElementById("purchasePrice").value;
      const currentValueRaw = document.getElementById("currentValue").value;
      const currentValueDate = document.getElementById("currentValueDate").value;
      const fullSet = document.getElementById("fullSet").checked;
      const notes = document.getElementById("notes").value.trim();

      const epochYear = epochYearRaw !== "" ? String(epochYearRaw) : "";
      const acquisitionYear = acquisitionYearRaw !== "" ? String(acquisitionYearRaw) : "";
      const purchasePrice = purchasePriceRaw !== "" ? Number(purchasePriceRaw) : null;
      const currentValue = currentValueRaw !== "" ? Number(currentValueRaw) : null;

      const baseItem = {
        type,
        brand,
        model,
        serial,
        epochYear,
        acquisitionYear,
        acquisitionPlace,
        purchasePrice,
        currentValue,
        currentValueDate,
        fullSet,
        notes
      };

      if (editingId !== null) {
        collection = collection.map(item => (item.id === editingId ? { ...item, ...baseItem } : item));
      } else {
        const newItem = {
          id: Date.now(),
          ...baseItem
        };
        collection.push(newItem);
      }

      saveToStorage();
      renderTable();
      resetForm();
    }

    function handleHeaderClick(event) {
      const th = event.currentTarget;
      const key = th.getAttribute("data-key");
      if (!key) return;

      if (currentSort.key === key) {
        currentSort.dir = currentSort.dir === "asc" ? "desc" : "asc";
      } else {
        currentSort.key = key;
        currentSort.dir = "asc";
      }
      renderTable();
    }

    function handleFilterChange(event) {
      filteredType = event.target.value || "all";
      renderTable();
    }

    function exportBackup() {
      const dataStr = JSON.stringify(collection, null, 2);
      const blob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);

      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, "0");
      const dd = String(now.getDate()).padStart(2, "0");

      const a = document.createElement("a");
      a.href = url;
      a.download = `collection-montres-${yyyy}${mm}${dd}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function handleBackupFileSelected(event) {
      const file = event.target.files[0];
      if (!file) return;

      const confirmMsg =
        "Importer cette sauvegarde va remplacer la collection actuelle.\n\nContinuer ?";
      if (!confirm(confirmMsg)) {
        event.target.value = "";
        return;
      }

      const reader = new FileReader();
      reader.onload = e => {
        try {
          const parsed = JSON.parse(e.target.result);
          if (!Array.isArray(parsed)) {
            alert("Fichier invalide : format inattendu.");
            return;
          }

          const cleaned = parsed.map((item, index) => {
            const base = typeof item === "object" && item !== null ? item : {};

            let acquisitionYear = base.acquisitionYear;
            if (!acquisitionYear && base.acquisitionDate) {
              const yearFromDate = String(base.acquisitionDate).slice(0, 4);
              if (/^\d{4}$/.test(yearFromDate)) {
                acquisitionYear = yearFromDate;
              }
            }

            return {
              id: base.id || Date.now() + index,
              type: base.type || "autre",
              brand: base.brand || "",
              model: base.model || "",
              serial: base.serial || "",
              epochYear: base.epochYear || "",
              acquisitionYear: acquisitionYear || "",
              acquisitionPlace: base.acquisitionPlace || "",
              purchasePrice:
                base.purchasePrice !== undefined && base.purchasePrice !== null
                  ? Number(base.purchasePrice)
                  : null,
              currentValue:
                base.currentValue !== undefined && base.currentValue !== null
                  ? Number(base.currentValue)
                  : null,
              currentValueDate: base.currentValueDate || "",
              fullSet: !!base.fullSet,
              notes: base.notes || ""
            };
          });

          collection = cleaned;
          saveToStorage();
          renderTable();
          resetForm();
          alert("Sauvegarde import√©e avec succ√®s ‚úîÔ∏è");
        } catch (err) {
          console.error("Erreur import sauvegarde", err);
          alert("Impossible de lire cette sauvegarde (JSON invalide).");
        } finally {
          event.target.value = "";
        }
      };
      reader.readAsText(file, "utf-8");
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadFromStorage();
      renderTable();

      document.getElementById("watchForm").addEventListener("submit", handleFormSubmit);
      document.getElementById("resetFormBtn").addEventListener("click", resetForm);

      const sortableHeaders = document.querySelectorAll("#watchTable thead th.sortable");
      sortableHeaders.forEach(th => th.addEventListener("click", handleHeaderClick));

      document.getElementById("filterType").addEventListener("change", handleFilterChange);

      document.getElementById("exportBackupBtn").addEventListener("click", exportBackup);

      const backupInput = document.getElementById("backupFileInput");
      document
        .getElementById("importBackupBtn")
        .addEventListener("click", () => backupInput.click());
      backupInput.addEventListener("change", handleBackupFileSelected);
    });
  </script>
</body>
</html>